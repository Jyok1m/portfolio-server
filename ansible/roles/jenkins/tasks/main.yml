- name: Create jenkins directory
  ansible.builtin.file:
    path: /opt/jenkins
    state: directory
    mode: "0755"

- name: Copy docker-compose.yml
  ansible.builtin.copy:
    src: docker-compose.yml
    dest: /opt/jenkins/docker-compose.yml
    mode: "0644"

- name: Copy Dockerfile
  ansible.builtin.copy:
    src: Dockerfile
    dest: /opt/jenkins/Dockerfile
    mode: "0644"

- name: Build Jenkins image
  ansible.builtin.command:
    cmd: docker build -t jyok1m/jenkins:latest .
    chdir: /opt/jenkins

- name: Push Jenkins image to Docker Hub
  ansible.builtin.command:
    cmd: docker push jyok1m/jenkins:latest

- name: Run docker compose up
  ansible.builtin.command:
    cmd: docker compose up -d
    chdir: /opt/jenkins

- name: Check if known_hosts exists in Jenkins container
  ansible.builtin.command:
    cmd: docker exec jenkins-gui test -f /var/jenkins_home/.ssh/known_hosts
  register: known_hosts_check
  failed_when: false
  changed_when: false

- name: Setup GitHub SSH known hosts in Jenkins
  ansible.builtin.command:
    cmd: >
      docker exec jenkins-gui bash -c
      "mkdir -p /var/jenkins_home/.ssh &&
      ssh-keyscan -t ed25519 github.com >> /var/jenkins_home/.ssh/known_hosts &&
      chown -R jenkins:jenkins /var/jenkins_home/.ssh"
  when: known_hosts_check.rc != 0